<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Analisi Avanzata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        /* Modificato: 8 colonne per includere il Totale Settimanale */
        .calendar-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; min-width: 600px; }
        .cal-cell { min-height: 80px; transition: all 0.2s; }
        .cal-cell:hover { transform: scale(1.02); z-index: 10; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-6 transition-colors duration-200 text-gray-800 dark:text-gray-100 font-sans">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold tracking-tight">Performance Analytics</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Analisi approfondita del tuo trading.</p>
            </div>
            <div class="flex gap-4 flex-wrap justify-end">
                <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded shadow text-center">
                    <span class="text-xs text-gray-500 uppercase block">Media/Settimana</span>
                    <span class="font-bold text-xl">{{ avg_weekly_trades }}</span>
                </div>
                 <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded shadow text-center border-l-4 border-indigo-500">
                    <span class="text-xs text-gray-500 uppercase block">R:R Medio (Win)</span>
                    <span class="font-bold text-xl">{{ avg_win_rr }}</span>
                </div>
                <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded shadow text-center">
                    <span class="text-xs text-gray-500 uppercase block">Trades/Giorno</span>
                    <span class="font-bold text-xl">{{ avg_daily_trades }}</span>
                </div>
                <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded shadow text-center">
                    <span class="text-xs text-gray-500 uppercase block">Sharpe Ratio</span>
                    <span class="font-bold text-xl">{{ sharpe_ratio }}</span>
                </div>
                <a href="/dashboard" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded transition flex items-center shadow-lg">‚Üê Journal</a>
            </div>
        </div>

        {% if no_data %}
            <div class="bg-white dark:bg-gray-800 p-12 rounded-lg shadow-lg text-center">
                <h2 class="text-2xl font-bold text-gray-600 dark:text-gray-300 mb-4">Nessun dato disponibile üìâ</h2>
                <a href="/dashboard" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Vai alla Dashboard</a>
            </div>
        {% else %}

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 {{ 'border-green-500' if net_result >= 0 else 'border-red-500' }}">
                <p class="text-xs font-bold uppercase text-gray-500">Net Profit</p>
                <p class="text-3xl font-bold {{ 'text-green-500' if net_result >= 0 else 'text-red-500' }}">{{ net_result }}%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 border-blue-500">
                <p class="text-xs font-bold uppercase text-gray-500">Win Rate Totale</p>
                <p class="text-3xl font-bold">{{ win_rate }}%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 border-purple-500">
                <p class="text-xs font-bold uppercase text-gray-500">Profit Factor</p>
                <p class="text-3xl font-bold">{{ profit_factor }}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 border-yellow-500">
                <p class="text-xs font-bold uppercase text-gray-500">Miglior Settimana</p>
                <p class="text-xl font-bold truncate">{{ best_week }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <div class="col-span-1 md:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Equity Curve + Proiezioni</h3>
                    <div class="flex gap-2 text-xs">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-blue-600 rounded-full"></span> Reale</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 border border-dashed border-green-500 block"></span> Futuro</span>
                    </div>
                </div>
                <div class="relative h-64 w-full"><canvas id="mainChart"></canvas></div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow flex flex-col items-center justify-center">
                <h3 class="font-bold text-lg mb-4">Direzione (Long vs Short)</h3>
                <div class="relative h-48 w-48"><canvas id="pieChart"></canvas></div>
                <div class="mt-4 w-full grid grid-cols-2 gap-4 text-center text-sm">
                    <div>
                        <span class="block text-green-500 font-bold">LONG ({{ long_stats.total }})</span>
                        <span class="text-gray-500">WR: {{ long_stats.win_rate }}%</span>
                    </div>
                    <div>
                        <span class="block text-red-500 font-bold">SHORT ({{ short_stats.total }})</span>
                        <span class="text-gray-500">WR: {{ short_stats.win_rate }}%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg text-red-600 dark:text-red-400">‚ö†Ô∏è Risk of Ruin (Simulato)</h3>
                    <span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">Basato su 1000 sim</span>
                </div>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                        <div class="text-xs text-gray-500 mb-1">Prob. Drawdown 10%</div>
                        <div class="font-bold text-lg {{ 'text-red-500' if risk_of_ruin['10'] > 20 else 'text-green-500' }}">{{ risk_of_ruin['10'] }}%</div>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                        <div class="text-xs text-gray-500 mb-1">Prob. Drawdown 20%</div>
                        <div class="font-bold text-lg {{ 'text-red-500' if risk_of_ruin['20'] > 10 else 'text-green-500' }}">{{ risk_of_ruin['20'] }}%</div>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                        <div class="text-xs text-gray-500 mb-1">Rovina Totale (100%)</div>
                        <div class="font-bold text-lg {{ 'text-red-500' if risk_of_ruin['100'] > 1 else 'text-green-500' }}">{{ risk_of_ruin['100'] }}%</div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow overflow-hidden">
                <h3 class="font-bold text-lg mb-4">üß† Analisi Emozioni</h3>
                <div class="overflow-y-auto max-h-40">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-700 sticky top-0">
                            <tr><th class="p-2">Stato</th><th class="p-2 text-center">Trades</th><th class="p-2 text-right">WR%</th><th class="p-2 text-right">PL%</th></tr>
                        </thead>
                        <tbody>
                            {% for emo in emotions_table %}
                            <tr class="border-b dark:border-gray-700">
                                <td class="p-2 font-bold capitalize">{{ emo.name }}</td>
                                <td class="p-2 text-center">{{ emo.total }}</td>
                                <td class="p-2 text-right {{ 'text-green-500' if emo.win_rate >= 50 else 'text-red-500' }}">{{ emo.win_rate }}%</td>
                                <td class="p-2 text-right font-bold {{ 'text-green-500' if emo.result > 0 else 'text-red-500' }}">{{ emo.result }}%</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="p-2 text-center text-gray-500">Nessun dato emotivo.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-gray-200 dark:bg-black p-6 rounded-xl shadow-inner mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold dark:text-white">Calendario P&L</h3>
                <div class="flex items-center gap-4">
                    <span class="text-xl font-bold {{ 'text-green-500' if month_pl >= 0 else 'text-red-500' }}">Mese: {{ month_pl }}%</span>
                    <form action="/statistics" method="GET">
                        <input type="month" name="month_ref" value="{{ selected_month }}" onchange="this.form.submit()" class="p-1 rounded text-sm dark:bg-gray-800 dark:text-white">
                    </form>
                </div>
            </div>
            
            <div class="bg-gray-800 dark:bg-gray-900 rounded-lg p-4 overflow-x-auto">
                <div class="calendar-grid mb-2 text-center text-gray-400 text-sm font-bold uppercase">
                    <div>Dom</div><div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div class="text-yellow-500">TOT</div>
                </div>
                
                {% for week in calendar_data %}
                <div class="calendar-grid mb-1">
                    {% for day in week.days %}
                        {% if day %}
                        <div class="cal-cell p-2 rounded relative flex flex-col justify-between border border-gray-700 bg-gray-800 hover:bg-gray-700">
                            <span class="text-xs text-gray-500 font-bold">{{ day.day }}</span>
                            {% if day.count > 0 %}
                                <div class="text-center">
                                    <span class="block font-bold text-sm {{ 'text-green-400' if day.pl > 0 else 'text-red-400' }}">{{ day.pl }}%</span>
                                    <span class="text-[10px] text-gray-500">{{ day.count }} trades</span>
                                </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="cal-cell bg-transparent"></div>
                        {% endif %}
                    {% endfor %}
                    
                    <div class="cal-cell p-2 rounded flex flex-col justify-center items-center border border-gray-700 bg-gray-900">
                         <span class="text-[10px] text-gray-400 uppercase">W. P&L</span>
                         <span class="font-bold text-sm {{ 'text-green-400' if week.week_pl > 0 else 'text-red-400' }}">{{ week.week_pl }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden border-t-4 border-indigo-600 mb-8">
            <div class="bg-gray-800 dark:bg-black px-4 py-3 font-bold text-white flex justify-between items-center">
                <span>üéØ Confluenze & Rischi</span>
                <span class="text-xs font-normal text-gray-300">Analisi combinata Setup</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">Tipo</th>
                            <th class="px-4 py-3">Nome Confluenza</th>
                            <th class="px-4 py-3 text-center">Utilizzi</th>
                            <th class="px-4 py-3 text-center">Win Rate</th>
                            <th class="px-4 py-3 text-right">Profitto Totale</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in confluences_table %}
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-4 py-3 font-bold text-xs uppercase {{ 'text-green-600' if row.type == 'Pro' else 'text-red-600' }}">
                                {{ row.type }}
                            </td>
                            <td class="px-4 py-3 font-bold text-gray-800 dark:text-gray-200">{{ row.name }}</td>
                            <td class="px-4 py-3 text-center">{{ row.total }}</td>
                            <td class="px-4 py-3 text-center font-bold {{ 'text-green-500' if row.win_rate >= 50 else 'text-red-500' }}">{{ row.win_rate }}%</td>
                            <td class="px-4 py-3 text-right font-bold {{ 'text-green-500' if row.result > 0 else 'text-red-500' }}">{{ row.result }}%</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Nessun dato sulle confluenze.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <div class="bg-gray-700 px-4 py-2 font-bold text-white text-sm">Barrier (Entry TF)</div>
                <table class="w-full text-sm text-left">
                     <thead class="bg-gray-100 dark:bg-gray-700 text-xs uppercase"><tr><th class="p-2">TF</th><th class="p-2 text-right">Profit</th></tr></thead>
                     <tbody>
                        {% for row in tf_table %}
                        <tr class="border-b dark:border-gray-700"><td class="p-2 font-bold">{{ row.name }}</td><td class="p-2 text-right {{ 'text-green-500' if row.result>0 else 'text-red-500' }}">{{ row.result }}%</td></tr>
                        {% endfor %}
                     </tbody>
                </table>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <div class="bg-gray-700 px-4 py-2 font-bold text-white text-sm">Alignment (Trend TF)</div>
                <table class="w-full text-sm text-left">
                     <thead class="bg-gray-100 dark:bg-gray-700 text-xs uppercase"><tr><th class="p-2">TF</th><th class="p-2 text-right">Profit</th></tr></thead>
                     <tbody>
                        {% for row in align_table %}
                        <tr class="border-b dark:border-gray-700"><td class="p-2 font-bold">{{ row.name }}</td><td class="p-2 text-right {{ 'text-green-500' if row.result>0 else 'text-red-500' }}">{{ row.result }}%</td></tr>
                        {% endfor %}
                     </tbody>
                </table>
            </div>
        </div>

        {% endif %}
    </div>

    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        
        {% if not no_data %}
        // --- EQUITY CHART ---
        const ctx = document.getElementById('mainChart').getContext('2d');
        const realData = {{ chart_data | safe }};
        const labels = {{ chart_labels | safe }};
        const mcSims = {{ mc_simulations | safe }};
        const projection = {{ projection_data | safe }};

        let datasets = [];
        mcSims.forEach((sim) => {
            datasets.push({ label: 'Sim', data: sim, borderColor: 'rgba(156, 163, 175, 0.1)', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.4 });
        });
        datasets.push({ label: 'Equity Reale', data: realData, borderColor: '#2563EB', backgroundColor: 'rgba(37, 99, 235, 0.1)', borderWidth: 3, pointRadius: 3, tension: 0.3, fill: true });
        
        let projLabels = [...labels];
        let emptyPad = new Array(realData.length - 1).fill(null);
        let projPlotData = [...emptyPad, ...projection]; 
        for(let i=0; i<20; i++) projLabels.push('Fut ' + (i+1));
        
        datasets.push({ label: 'Proiezione', data: projPlotData, borderColor: '#10B981', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, fill: false });

        new Chart(ctx, {
            type: 'line',
            data: { labels: projLabels, datasets: datasets },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { display: false }, y: { grid: { color: '#374151' } } } }
        });

        // --- PIE CHART (LONG vs SHORT) ---
        const ctxPie = document.getElementById('pieChart').getContext('2d');
        new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['Long', 'Short'],
                datasets: [{
                    data: [{{ long_stats.total }}, {{ short_stats.total }}],
                    backgroundColor: ['#10B981', '#EF4444'], // Green, Red
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '70%'
            }
        });
        {% endif %}
    </script>
</body>
</html>