<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 p-4 transition-colors duration-200">

    <div class="max-w-[98%] mx-auto">
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="{{ url_for('static', filename='logo.avif') }}" alt="Logo" class="h-16 object-contain bg-white rounded p-1">
                <h1 class="text-2xl font-bold hidden md:block">Diario di {{ user.username }} {% if admin_view %}<span class="text-red-500 text-sm">(ADMIN)</span>{% endif %}</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleDarkMode()" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-full">üåì</button>
                <a href="/settings" class="bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded font-bold">‚öôÔ∏è Setup</a>
                <a href="/statistics" class="bg-indigo-600 text-white py-2 px-4 rounded font-bold">üìä Stats</a>
                <a href="/logout" class="bg-red-500 text-white py-2 px-4 rounded font-bold">Esci</a>
            </div>
        </div>

        <div class="bg-gray-200 dark:bg-gray-800 p-3 rounded shadow mb-6 flex flex-wrap gap-4 items-center">
            <span class="font-bold text-sm uppercase text-gray-500">Filtra per:</span>
            <form action="/dashboard" method="GET" class="flex gap-2 flex-wrap w-full md:w-auto">
                <input type="month" name="date_filter" value="{{ request.args.get('date_filter', '') }}" class="p-1 rounded text-black border dark:bg-gray-600 dark:text-white">
                <select name="outcome_filter" class="p-1 rounded text-black border dark:bg-gray-600 dark:text-white">
                    <option value="">Tutti gli Esiti</option>
                    <option value="Target" {% if request.args.get('outcome_filter') == 'Target' %}selected{% endif %}>Target</option>
                    <option value="Stop Loss" {% if request.args.get('outcome_filter') == 'Stop Loss' %}selected{% endif %}>Stop Loss</option>
                    <option value="Breakeven" {% if request.args.get('outcome_filter') == 'Breakeven' %}selected{% endif %}>Breakeven</option>
                </select>
                <input type="text" name="pair_filter" placeholder="Coppia (es. EURUSD)" value="{{ request.args.get('pair_filter', '') }}" class="p-1 rounded text-black border dark:bg-gray-600 dark:text-white uppercase">
                <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">Cerca</button>
                <a href="/dashboard" class="text-sm underline text-gray-500 self-center">Reset</a>
            </form>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="mb-4 p-3 rounded text-white font-bold {{ 'bg-green-500' if category == 'success' else 'bg-red-500' }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-8 border-t-4 border-blue-600">
            <h2 class="text-lg font-semibold mb-4 border-b dark:border-gray-700 pb-2">Nuova Operazione</h2>
            <form action="/add_trade" method="POST">
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-3">
                    <select name="pair" class="border p-2 rounded w-full dark:bg-gray-700 dark:border-gray-600" required>
                        <option value="" disabled selected>Asset</option>
                        <optgroup label="Forex"><option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>USDCAD</option><option>AUDUSD</option></optgroup>
                        <optgroup label="Crosses"><option>EURGBP</option><option>GBPJPY</option><option>EURJPY</option></optgroup>
                        <optgroup label="Commodities"><option>XAUUSD</option><option>WTI</option></optgroup>
                        <optgroup label="Indices"><option>US30</option><option>NAS100</option><option>SPX500</option><option>DAX40</option></optgroup>
                        <optgroup label="Crypto"><option>BTCUSD</option><option>ETHUSD</option></optgroup>
                    </select>
                    <input type="date" name="date" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600" required>
                    <input type="time" name="time" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600" required>
                    <select name="direction" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600"><option>Long</option><option>Short</option></select>
                    <select name="outcome" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600"><option>Target</option><option>Stop Loss</option><option>Breakeven</option><option>Non Fillato</option><option>Setup</option></select>
                    <select name="emotions" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600"><option value="" disabled selected>Emozione</option><option>ansia</option><option>stress</option><option>paura</option><option>fretta</option><option>tranquillo</option><option>sicuro</option><option>calmo</option></select>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <input type="number" step="0.01" name="risk_percent" placeholder="Rischio %" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600">
                    <input type="number" step="0.01" name="rr_final" placeholder="RR Finale" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600">
                    <input type="number" step="0.01" name="result_percent" placeholder="Risultato %" class="border p-2 rounded bg-yellow-50 dark:bg-gray-600 font-bold border-yellow-300">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 border-t dark:border-gray-700 pt-3">
                    <div>
                        <p class="text-xs font-bold mb-1">Timeframes</p>
                        <div class="flex flex-wrap gap-2">{% for tf in ['m1','m3','m5','m15','h1','h4','D1'] %}<label class="inline-flex items-center bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded"><input type="checkbox" name="timeframe" value="{{tf}}" class="mr-1"> <span class="text-xs">{{tf}}</span></label>{% endfor %}</div>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-green-600 mb-1">Pro</p>
                        <div class="space-y-1">{% for pro in user_pros %}<label class="flex items-center"><input type="checkbox" name="pros" value="{{pro}}" class="mr-1 text-green-600"><span class="text-xs">{{pro}}</span></label>{% endfor %}</div>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-red-600 mb-1">Contro</p>
                        <div class="space-y-1">{% for con in user_cons %}<label class="flex items-center"><input type="checkbox" name="cons" value="{{con}}" class="mr-1 text-red-600"><span class="text-xs">{{con}}</span></label>{% endfor %}</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" name="link1" placeholder="Link 1" class="border p-2 rounded w-full dark:bg-gray-700 dark:border-gray-600">
                    <input type="text" name="link2" placeholder="Link 2" class="border p-2 rounded w-full dark:bg-gray-700 dark:border-gray-600">
                </div>
                <textarea name="notes" placeholder="Note..." class="border p-2 rounded w-full h-12 mb-3 dark:bg-gray-700 dark:border-gray-600"></textarea>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 w-full rounded hover:bg-blue-700">Salva</button>
            </form>
        </div>

        <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded shadow">
            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs uppercase bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    <tr>
                        {% if admin_view %}<th class="px-4 py-3">User</th>{% endif %}
                        <th class="px-4 py-3">Data</th><th class="px-4 py-3">Asset</th><th class="px-4 py-3">TF</th><th class="px-4 py-3">Esito</th><th class="px-4 py-3">Ris %</th><th class="px-4 py-3">Note</th><th class="px-4 py-3 text-center">Link</th><th class="px-4 py-3 text-right">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in pagination.items %}
                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                        {% if admin_view %}<td class="px-4 py-3 font-bold">{{ trade.author.username }}</td>{% endif %}
                        <td class="px-4 py-3"><div class="font-bold">{{ trade.date.strftime('%d-%m') }}</div><div class="text-xs">{{ trade.time }}</div></td>
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ trade.pair }}</td>
                        <td class="px-4 py-3 text-xs">{{ trade.timeframe }}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold text-white {% if trade.outcome=='Target' %}bg-green-500{% elif trade.outcome=='Stop Loss' %}bg-red-500{% else %}bg-gray-400{% endif %}">{{ trade.outcome }}</span><div class="text-xs mt-1 font-bold">{{ trade.direction }}</div></td>
                        <td class="px-4 py-3 font-bold {% if trade.result_percent > 0 %}text-green-500{% elif trade.result_percent < 0 %}text-red-500{% endif %}">{{ trade.result_percent }}%</td>
                        <td class="px-4 py-3 text-xs truncate max-w-[100px]">{{ trade.selected_pros }}</td>
                        <td class="px-4 py-3 text-center">
                            {% if trade.screen_pre %}
                                {% for link in trade.screen_pre.split(',') %}{% if link %}<a href="{{link}}" target="_blank" class="inline-block w-5 h-5 bg-blue-100 text-blue-600 rounded-full text-center hover:bg-blue-600 hover:text-white transition">‚Üó</a>{% endif %}{% endfor %}
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <a href="/edit_trade/{{ trade.id }}" class="text-blue-500 hover:underline">Edit</a>
                            <a href="/delete_trade/{{ trade.id }}" onclick="return confirm('Sicuro?')" class="text-red-500 hover:underline ml-2">X</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="flex justify-center mt-6 gap-2">
            {% if pagination.has_prev %}
                <a href="{{ url_for('dashboard', page=pagination.prev_num, **request.args) }}" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded">Prev</a>
            {% endif %}
            <span class="px-3 py-1">Pag {{ pagination.page }}</span>
            {% if pagination.has_next %}
                <a href="{{ url_for('dashboard', page=pagination.next_num, **request.args) }}" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded">Next</a>
            {% endif %}
        </div>
    </div>

    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }
    </script>
</body>
</html>