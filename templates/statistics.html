<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Analisi Avanzata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-cell { min-height: 80px; transition: all 0.2s; }
        .cal-cell:hover { transform: scale(1.02); z-index: 10; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-6 transition-colors duration-200 text-gray-800 dark:text-gray-100 font-sans">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold tracking-tight">Performance Analytics</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Analisi approfondita del tuo trading.</p>
            </div>
            <div class="flex gap-4">
                <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded shadow text-center">
                    <span class="text-xs text-gray-500 uppercase block">Trades / Giorni</span>
                    <span class="font-bold text-xl">{{ total_trades }} / {{ total_days }}</span>
                </div>
                <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded shadow text-center">
                    <span class="text-xs text-gray-500 uppercase block">Media/Settimana</span>
                    <span class="font-bold text-xl">{{ avg_weekly_trades }}</span>
                </div>
                 <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded shadow text-center border-l-4 border-indigo-500">
                    <span class="text-xs text-gray-500 uppercase block">Sharpe Ratio</span>
                    <span class="font-bold text-xl">{{ sharpe_ratio }}</span>
                </div>
                <a href="/dashboard" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded transition flex items-center shadow-lg">‚Üê Journal</a>
            </div>
        </div>

        {% if no_data %}
            <div class="bg-white dark:bg-gray-800 p-12 rounded-lg shadow-lg text-center">
                <h2 class="text-2xl font-bold text-gray-600 dark:text-gray-300 mb-4">Nessun dato disponibile üìâ</h2>
                <a href="/dashboard" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Vai alla Dashboard</a>
            </div>
        {% else %}

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 {{ 'border-green-500' if net_result >= 0 else 'border-red-500' }}">
                <p class="text-xs font-bold uppercase text-gray-500">Net Profit</p>
                <p class="text-3xl font-bold {{ 'text-green-500' if net_result >= 0 else 'text-red-500' }}">{{ net_result }}%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 border-blue-500">
                <p class="text-xs font-bold uppercase text-gray-500">Win Rate</p>
                <p class="text-3xl font-bold">{{ win_rate }}%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 border-purple-500">
                <p class="text-xs font-bold uppercase text-gray-500">Profit Factor</p>
                <p class="text-3xl font-bold">{{ profit_factor }}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-b-4 border-yellow-500">
                <p class="text-xs font-bold uppercase text-gray-500">Miglior Settimana</p>
                <p class="text-xl font-bold truncate">{{ best_week }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg text-red-600 dark:text-red-400">‚ö†Ô∏è Risk of Ruin (Simulato)</h3>
                    <span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">Basato su 500 sim</span>
                </div>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                        <div class="text-xs text-gray-500 mb-1">Prob. Drawdown 10%</div>
                        <div class="font-bold text-lg {{ 'text-red-500' if risk_of_ruin['10'] > 20 else 'text-green-500' }}">{{ risk_of_ruin['10'] }}%</div>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                        <div class="text-xs text-gray-500 mb-1">Prob. Drawdown 20%</div>
                        <div class="font-bold text-lg {{ 'text-red-500' if risk_of_ruin['20'] > 10 else 'text-green-500' }}">{{ risk_of_ruin['20'] }}%</div>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                        <div class="text-xs text-gray-500 mb-1">Rovina Totale (100%)</div>
                        <div class="font-bold text-lg {{ 'text-red-500' if risk_of_ruin['100'] > 1 else 'text-green-500' }}">{{ risk_of_ruin['100'] }}%</div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-4">üìÖ Performance per Settimana del Mese</h3>
                <div class="overflow-y-auto max-h-40">
                    <table class="w-full text-sm">
                        <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-700 sticky top-0"><tr><th class="p-2 text-left">Settimana</th><th class="p-2 text-right">WR%</th><th class="p-2 text-right">Profit</th></tr></thead>
                        <tbody>
                            {% for w in week_table %}
                            <tr class="border-b dark:border-gray-700">
                                <td class="p-2 font-medium">{{ w.name }}</td>
                                <td class="p-2 text-right">{{ w.win_rate }}%</td>
                                <td class="p-2 text-right font-bold {{ 'text-green-500' if w.pl > 0 else 'text-red-500' }}">{{ w.pl }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl">Equity Curve + Monte Carlo & Projection</h3>
                <div class="flex gap-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-600 rounded-full"></span> Reale</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-gray-300 rounded-full"></span> Monte Carlo (Sim)</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 border border-dashed border-green-500 block"></span> Proiezione</span>
                </div>
            </div>
            <div class="relative h-80 w-full"><canvas id="mainChart"></canvas></div>
        </div>

        <div class="bg-gray-200 dark:bg-black p-6 rounded-xl shadow-inner mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold dark:text-white">Calendario P&L</h3>
                <div class="flex items-center gap-4">
                    <span class="text-xl font-bold {{ 'text-green-500' if month_pl >= 0 else 'text-red-500' }}">Mese: {{ month_pl }}%</span>
                    <form action="/statistics" method="GET">
                        <input type="month" name="month_ref" value="{{ selected_month }}" onchange="this.form.submit()" class="p-1 rounded text-sm dark:bg-gray-800 dark:text-white">
                    </form>
                </div>
            </div>
            
            <div class="bg-gray-800 dark:bg-gray-900 rounded-lg p-4">
                <div class="calendar-grid mb-2 text-center text-gray-400 text-sm font-bold uppercase">
                    <div>Dom</div><div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div>
                </div>
                
                {% for week in calendar_data %}
                <div class="calendar-grid mb-1">
                    {% for day in week.days %}
                        {% if day %}
                        <div class="cal-cell p-2 rounded relative flex flex-col justify-between border border-gray-700 bg-gray-800 hover:bg-gray-700">
                            <span class="text-xs text-gray-500 font-bold">{{ day.day }}</span>
                            {% if day.count > 0 %}
                                <div class="text-center">
                                    <span class="block font-bold text-sm {{ 'text-green-400' if day.pl > 0 else 'text-red-400' }}">{{ day.pl }}%</span>
                                    <span class="text-[10px] text-gray-500">{{ day.count }} trades</span>
                                </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="cal-cell bg-transparent"></div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="text-right text-xs text-gray-400 mb-4 pr-2 border-b border-gray-700 pb-1">
                    Week Recap: <span class="{{ 'text-green-400' if week.week_pl > 0 else 'text-red-400' }} font-bold ml-2">{{ week.week_pl }}%</span> ({{ week.trade_count }} trades)
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <div class="bg-gray-800 dark:bg-black px-4 py-3 font-bold text-white flex justify-between"><span>Barrier (Entry)</span> <span>TF</span></div>
                <div class="overflow-x-auto max-h-64">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs"><tr><th class="px-4 py-2">TF</th><th class="px-4 py-2 text-right">Profit</th></tr></thead>
                        <tbody>
                            {% for row in tf_table %}
                            <tr class="border-b dark:border-gray-700"><td class="px-4 py-2 font-bold">{{ row.name }}</td><td class="px-4 py-2 text-right font-bold {{ 'text-green-500' if row.result>0 else 'text-red-500' }}">{{ row.result }}%</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <div class="bg-gray-800 dark:bg-black px-4 py-3 font-bold text-white flex justify-between"><span>Alignment (Trend)</span> <span>TF</span></div>
                <div class="overflow-x-auto max-h-64">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs"><tr><th class="px-4 py-2">TF</th><th class="px-4 py-2 text-right">Profit</th></tr></thead>
                        <tbody>
                            {% for row in align_table %}
                            <tr class="border-b dark:border-gray-700"><td class="px-4 py-2 font-bold">{{ row.name }}</td><td class="px-4 py-2 text-right font-bold {{ 'text-green-500' if row.result>0 else 'text-red-500' }}">{{ row.result }}%</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                <div class="bg-gray-800 dark:bg-black px-4 py-3 font-bold text-white">Top Giorni</div>
                <div class="overflow-x-auto max-h-64">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs"><tr><th class="px-4 py-2">Giorno</th><th class="px-4 py-2 text-right">Profit</th></tr></thead>
                        <tbody>
                            {% for row in day_table %}
                            <tr class="border-b dark:border-gray-700"><td class="px-4 py-2">{{ row.name }}</td><td class="px-4 py-2 text-right font-bold {{ 'text-green-500' if row.res>0 else 'text-red-500' }}">{{ row.res }}%</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% endif %}
    </div>

    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        
        {% if not no_data %}
        const ctx = document.getElementById('mainChart').getContext('2d');
        const realData = {{ chart_data | safe }};
        const labels = {{ chart_labels | safe }};
        const mcSims = {{ mc_simulations | safe }};
        const projection = {{ projection_data | safe }};

        // Costruisci Datasets: 1 Reale + 20 Montecarlo (faded) + 1 Proiezione
        let datasets = [];

        // Montecarlo (Background lines)
        mcSims.forEach((sim) => {
            datasets.push({
                label: 'Sim',
                data: sim,
                borderColor: 'rgba(156, 163, 175, 0.15)', // Grigio molto chiaro
                borderWidth: 1,
                pointRadius: 0,
                fill: false,
                tension: 0.4
            });
        });

        // Curva Reale
        datasets.push({
            label: 'Equity Reale',
            data: realData,
            borderColor: '#2563EB', // Blue 600
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            borderWidth: 3,
            pointRadius: 3,
            tension: 0.3,
            fill: true
        });

        // Proiezione Futura (appendi alla fine)
        // Creiamo etichette fittizie per il futuro
        let projLabels = [...labels];
        let emptyPad = new Array(realData.length - 1).fill(null);
        let projPlotData = [...emptyPad, ...projection]; // Inizia dove finisce il reale
        
        for(let i=0; i<20; i++) projLabels.push('Futuro ' + (i+1));

        datasets.push({
            label: 'Proiezione Teorica',
            data: projPlotData,
            borderColor: '#10B981', // Green 500
            borderDash: [5, 5],
            borderWidth: 2,
            pointRadius: 0,
            fill: false
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: projLabels, // Usa etichette estese
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { display: false }, // Nascondi asse X per pulizia
                    y: { grid: { color: '#374151' } }
                }
            }
        });
        {% endif %}
    </script>
</body>
</html>