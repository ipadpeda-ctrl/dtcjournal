<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 p-4 transition-colors duration-200">

    <div class="max-w-[98%] mx-auto">
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="{{ url_for('static', filename='logo.avif') }}" alt="Logo" class="h-16 object-contain bg-white rounded p-1">
                <h1 class="text-2xl font-bold hidden md:block">Diario di {{ user.username }} {% if admin_view %}<span class="text-red-500 text-sm">(ADMIN)</span>{% endif %}</h1>
            </div>
            <div class="flex gap-2 items-center flex-wrap justify-end">
                <button onclick="toggleDarkMode()" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-full hover:bg-gray-300 transition">üåì</button>
                
                {% if admin_view %}
                <a href="/admin_panel" class="bg-red-600 text-white py-2 px-4 rounded font-bold hover:bg-red-700 transition shadow">üëÆ Admin Panel</a>
                {% endif %}

                <a href="/rules" class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 py-2 px-4 rounded font-bold border border-yellow-300 dark:border-yellow-700 hover:opacity-80 transition">üìú Regole</a>
                <a href="/settings" class="bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded font-bold hover:bg-gray-300 transition">‚öôÔ∏è Setup</a>
                <a href="/statistics" class="bg-indigo-600 text-white py-2 px-4 rounded font-bold hover:bg-indigo-700 transition shadow-lg">üìä Stats</a>
                <a href="/logout" class="bg-red-500 text-white py-2 px-4 rounded font-bold hover:bg-red-600 transition">Esci</a>
            </div>
        </div>

        <div class="bg-gray-200 dark:bg-gray-800 p-4 rounded shadow mb-6 flex flex-wrap gap-4 items-center justify-between">
            <div class="flex items-center gap-2 w-full md:w-auto">
                <span class="font-bold text-sm uppercase text-gray-500">Filtra:</span>
                <form action="/dashboard" method="GET" class="flex gap-2 flex-wrap items-center">
                    <input type="month" name="date_filter" value="{{ request.args.get('date_filter', '') }}" class="p-1.5 rounded border dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    
                    <select name="pair_filter" class="p-1.5 rounded border dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm w-28">
                        <option value="">Asset</option>
                        {% if custom_pairs %}
                        <optgroup label="I Miei Strumenti">
                            {% for cp in custom_pairs %}
                            <option value="{{ cp }}" {% if request.args.get('pair_filter') == cp %}selected{% endif %}>{{ cp }}</option>
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                        <optgroup label="Forex Majors"><option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>USDCAD</option><option>AUDUSD</option></optgroup>
                        <optgroup label="Forex Crosses"><option>EURGBP</option><option>GBPJPY</option><option>EURJPY</option><option>AUDJPY</option><option>CADJPY</option></optgroup>
                        <optgroup label="Commodities"><option>XAUUSD</option><option>XAGUSD</option><option>WTI</option></optgroup>
                        <optgroup label="Indices"><option>US30</option><option>NAS100</option><option>SPX500</option><option>DAX40</option><option>UK100</option></optgroup>
                        <optgroup label="Crypto"><option>BTCUSD</option><option>ETHUSD</option><option>SOLUSD</option></optgroup>
                    </select>

                    <select name="outcome_filter" class="p-1.5 rounded border dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                        <option value="">Esito</option>
                        <option value="Target" {% if request.args.get('outcome_filter') == 'Target' %}selected{% endif %}>Target</option>
                        <option value="Stop Loss" {% if request.args.get('outcome_filter') == 'Stop Loss' %}selected{% endif %}>Stop Loss</option>
                        <option value="Breakeven" {% if request.args.get('outcome_filter') == 'Breakeven' %}selected{% endif %}>Breakeven</option>
                    </select>
                    <button type="submit" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-bold hover:bg-blue-700">VAI</button>
                    <a href="/dashboard" class="text-xs text-gray-500 underline ml-1">Reset</a>
                </form>
            </div>

            <div class="flex gap-6 text-sm font-mono bg-white dark:bg-gray-700 px-4 py-2 rounded border dark:border-gray-600 shadow-sm ml-auto">
                <div class="text-center"><span class="block text-[10px] uppercase text-gray-400">Trades</span><b class="text-lg">{{ filter_stats.total }}</b></div>
                <div class="text-center"><span class="block text-[10px] uppercase text-gray-400">Win Rate</span><b class="{{ 'text-green-500' if filter_stats.win_rate>=50 else 'text-red-500' }} text-lg">{{ filter_stats.win_rate }}%</b></div>
                <div class="text-center"><span class="block text-[10px] uppercase text-gray-400">Profit</span><b class="{{ 'text-green-500' if filter_stats.net_profit>0 else 'text-red-500' }} text-lg">{{ filter_stats.net_profit }}%</b></div>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="mb-4 p-3 rounded text-white font-bold shadow-md {{ 'bg-green-600' if category == 'success' else 'bg-red-600' }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="bg-white dark:bg-gray-800 p-5 rounded shadow mb-8 border-t-4 border-blue-600 transition-all hover:shadow-lg">
            <h2 class="text-lg font-semibold mb-4 border-b dark:border-gray-700 pb-2 text-gray-700 dark:text-gray-200">Inserisci Operazione</h2>
            <form action="/add_trade" method="POST" id="tradeForm">
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4">
                    <select name="pair" class="border p-2 rounded w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500" required>
                        <option value="" disabled selected>Seleziona Asset</option>
                        {% if custom_pairs %}
                        <optgroup label="I Miei Strumenti">
                            {% for cp in custom_pairs %}
                            <option value="{{ cp }}">{{ cp }}</option>
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                        <optgroup label="Forex Majors"><option>EURUSD</option><option>GBPUSD</option><option>USDJPY</option><option>USDCAD</option><option>AUDUSD</option></optgroup>
                        <optgroup label="Forex Crosses"><option>EURGBP</option><option>GBPJPY</option><option>EURJPY</option><option>AUDJPY</option><option>CADJPY</option></optgroup>
                        <optgroup label="Commodities"><option>XAUUSD</option><option>XAGUSD</option><option>WTI</option></optgroup>
                        <optgroup label="Indices"><option>US30</option><option>NAS100</option><option>SPX500</option><option>DAX40</option><option>UK100</option></optgroup>
                        <optgroup label="Crypto"><option>BTCUSD</option><option>ETHUSD</option><option>SOLUSD</option></optgroup>
                    </select>
                    <input type="date" name="date" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    <input type="time" name="time" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    <select name="direction" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option>Long</option><option>Short</option></select>
                    <select name="outcome" id="outcome" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option>Target</option><option>Stop Loss</option><option>Breakeven</option><option>Non Fillato</option><option>Setup</option></select>
                    <select name="emotions" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="" disabled selected>Emozione</option><option>ansia</option><option>stress</option><option>paura</option><option>fretta</option><option>tranquillo</option><option>sicuro</option><option>calmo</option></select>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                    <input type="number" step="0.01" name="risk_percent" id="risk_percent" placeholder="Rischio %" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <input type="number" step="0.1" name="pips_sl" id="pips_sl" placeholder="Pips SL" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white text-red-500">
                    <input type="number" step="0.1" name="pips_tp" id="pips_tp" placeholder="Pips TP" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white text-green-500">
                    <input type="number" step="0.01" name="rr_final" id="rr_final" placeholder="RR Finale" class="border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white bg-gray-100 dark:bg-gray-600">
                    <input type="number" step="0.01" name="result_percent" id="result_percent" placeholder="Risultato %" class="border p-2 rounded bg-yellow-50 dark:bg-gray-600 font-bold border-yellow-300 dark:border-yellow-600">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 border-t dark:border-gray-700 pt-4">
                    <div>
                        <p class="text-xs font-bold mb-2 text-gray-500 uppercase">Barrier (Entry)</p>
                        <div class="flex flex-wrap gap-2">{% for tf in ['m1','m3','m5','m15','m30'] %}<label class="inline-flex items-center bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600"><input type="checkbox" name="timeframe_barrier" value="{{tf}}" class="mr-1 accent-blue-600"> <span class="text-xs">{{tf}}</span></label>{% endfor %}</div>
                    </div>
                    <div>
                        <p class="text-xs font-bold mb-2 text-gray-500 uppercase">Alignment (Trend)</p>
                        <div class="flex flex-wrap gap-2">{% for tf in ['h1','h4','D1','W','M'] %}<label class="inline-flex items-center bg-blue-50 dark:bg-gray-800 border border-blue-200 dark:border-gray-600 px-2 py-1 rounded cursor-pointer"><input type="checkbox" name="timeframe_align" value="{{tf}}" class="mr-1 accent-purple-600"> <span class="text-xs">{{tf}}</span></label>{% endfor %}</div>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-green-600 mb-2 uppercase">Conferme (Pro)</p>
                        <div class="space-y-1">{% for pro in user_pros %}<label class="flex items-center hover:bg-gray-50 dark:hover:bg-gray-700 rounded px-1"><input type="checkbox" name="pros" value="{{pro}}" class="mr-2 accent-green-600"><span class="text-xs">{{pro}}</span></label>{% endfor %}</div>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-red-600 mb-2 uppercase">Rischi (Contro)</p>
                        <div class="space-y-1">{% for con in user_cons %}<label class="flex items-center hover:bg-gray-50 dark:hover:bg-gray-700 rounded px-1"><input type="checkbox" name="cons" value="{{con}}" class="mr-2 accent-red-600"><span class="text-xs">{{con}}</span></label>{% endfor %}</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input type="text" name="link1" placeholder="Link Screenshot 1" class="border p-2 rounded w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    <input type="text" name="link2" placeholder="Link Screenshot 2" class="border p-2 rounded w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                </div>
                <textarea name="notes" placeholder="Note operative..." class="border p-2 rounded w-full h-16 mb-4 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm"></textarea>
                
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 w-full rounded hover:bg-blue-700 transition shadow-md">Salva nel Journal</button>
            </form>
        </div>

        <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded shadow">
            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs uppercase bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                    <tr>
                        {% if admin_view %}<th class="px-4 py-3">User</th>{% endif %}
                        <th class="px-4 py-3">Data</th><th class="px-4 py-3">Asset</th><th class="px-4 py-3">TF (B/A)</th><th class="px-4 py-3">Esito</th><th class="px-4 py-3">Pips</th><th class="px-4 py-3">Ris %</th><th class="px-4 py-3 text-center">Link</th><th class="px-4 py-3 text-right">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in pagination.items %}
                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        {% if admin_view %}<td class="px-4 py-3 font-bold">{{ trade.author.username }}</td>{% endif %}
                        <td class="px-4 py-3"><div class="font-bold text-gray-800 dark:text-white">{{ trade.date.strftime('%d-%m') }}</div><div class="text-xs text-gray-400">{{ trade.time }}</div></td>
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ trade.pair }}</td>
                        <td class="px-4 py-3 text-xs">
                            <div class="text-blue-600 dark:text-blue-400 font-bold" title="Barrier">{{ trade.timeframe }}</div>
                            <div class="text-purple-600 dark:text-purple-400" title="Alignment">{{ trade.alignment }}</div>
                        </td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold text-white {% if trade.outcome=='Target' %}bg-green-500{% elif trade.outcome=='Stop Loss' %}bg-red-500{% elif trade.outcome=='Setup' %}bg-purple-500{% else %}bg-gray-400{% endif %}">{{ trade.outcome }}</span><div class="text-xs mt-1 font-bold text-gray-500">{{ trade.direction }}</div></td>
                        <td class="px-4 py-3 text-xs">
                            {% if trade.pips_tp > 0 %}<span class="text-green-500">TP: {{ trade.pips_tp }}</span><br>{% endif %}
                            {% if trade.pips_sl > 0 %}<span class="text-red-500">SL: {{ trade.pips_sl }}</span>{% endif %}
                        </td>
                        <td class="px-4 py-3 font-bold {% if trade.result_percent > 0 %}text-green-500{% elif trade.result_percent < 0 %}text-red-500{% endif %}">{{ trade.result_percent }}%</td>
                        <td class="px-4 py-3 text-center">
                            {% if trade.screen_pre %}
                                {% set links = trade.screen_pre.split(',') %}
                                <button onclick="openGallery(['{{ links[0] }}'{% if links|length > 1 %},'{{ links[1] }}'{% endif %}], 0)" class="inline-block px-2 py-1 bg-blue-100 text-blue-600 rounded text-xs font-bold hover:bg-blue-600 hover:text-white transition">
                                    IMG üì∑
                                </button>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <a href="/edit_trade/{{ trade.id }}" class="text-blue-500 hover:underline">Edit</a>
                            <a href="/delete_trade/{{ trade.id }}" onclick="return confirm('Sicuro?')" class="text-red-500 hover:underline ml-2">X</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="flex justify-center mt-6 gap-2">
            {% if pagination.has_prev %}<a href="{{ url_for('dashboard', page=pagination.prev_num, **request.args) }}" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition">Prev</a>{% endif %}
            <span class="px-3 py-1 text-gray-500 dark:text-gray-400">Pag {{ pagination.page }}</span>
            {% if pagination.has_next %}<a href="{{ url_for('dashboard', page=pagination.next_num, **request.args) }}" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition">Next</a>{% endif %}
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-95 flex items-center justify-center">
        <button onclick="closeGallery()" class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-400">&times;</button>
        <button onclick="changeImage(-1)" class="absolute left-4 text-white text-4xl font-bold hover:text-gray-400 p-4">‚ùÆ</button>
        
        <div class="max-w-[90%] max-h-[90%]">
             <img id="modalImage" src="" class="max-w-full max-h-[85vh] object-contain mx-auto rounded border border-gray-700">
             <div class="text-center mt-4">
                 <a id="modalLinkOriginal" href="#" target="_blank" class="text-blue-400 hover:underline text-sm">Apri immagine originale ‚Üó</a>
             </div>
        </div>

        <button onclick="changeImage(1)" class="absolute right-4 text-white text-4xl font-bold hover:text-gray-400 p-4">‚ùØ</button>
    </div>

    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        // --- AUTOMAZIONE CAMPI JS ---
        document.addEventListener("DOMContentLoaded", function() {
            const riskInput = document.getElementById('risk_percent');
            const rrInput = document.getElementById('rr_final');
            const slInput = document.getElementById('pips_sl');
            const tpInput = document.getElementById('pips_tp');
            const outcomeSelect = document.getElementById('outcome');
            const resultInput = document.getElementById('result_percent');

            function calculateStats() {
                const sl = parseFloat(slInput.value) || 0;
                const tp = parseFloat(tpInput.value) || 0;
                const risk = parseFloat(riskInput.value) || 0;
                const outcome = outcomeSelect.value;
                let rr = parseFloat(rrInput.value) || 0;

                if (sl > 0 && tp > 0) {
                    rr = (tp / sl);
                    rrInput.value = rr.toFixed(2);
                }

                if (outcome === 'Stop Loss') {
                    if (risk > 0) resultInput.value = (-risk).toFixed(2);
                } else if (outcome === 'Target') {
                    const currentRR = rr > 0 ? rr : (parseFloat(rrInput.value) || 0);
                    if (risk > 0 && currentRR > 0) resultInput.value = (risk * currentRR).toFixed(2);
                } else if (outcome === 'Breakeven') {
                    resultInput.value = 0;
                }
            }

            [riskInput, rrInput, slInput, tpInput, outcomeSelect].forEach(el => {
                if(el) el.addEventListener('input', calculateStats);
                if(el) el.addEventListener('change', calculateStats);
            });
        });

        // --- GALLERY LOGIC ---
        let currentImages = [];
        let currentIndex = 0;
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const modalLink = document.getElementById('modalLinkOriginal');

        function openGallery(images, index) {
            currentImages = images;
            currentIndex = index;
            if(currentImages.length > 0) {
                updateModalImage();
                modal.classList.remove('hidden');
            }
        }

        function closeGallery() {
            modal.classList.add('hidden');
            modalImg.src = "";
        }

        function changeImage(step) {
            currentIndex += step;
            if(currentIndex < 0) currentIndex = currentImages.length - 1;
            if(currentIndex >= currentImages.length) currentIndex = 0;
            updateModalImage();
        }

        function updateModalImage() {
            const src = currentImages[currentIndex];
            modalImg.src = src;
            modalLink.href = src;
        }

        // Close modal on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeGallery();
        });
    </script>
</body>
</html>